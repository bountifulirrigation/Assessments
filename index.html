
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Assessment History</title>
<style>
  :root {
    --brand: #2A6F97;
    --bg: #f8fafc;
    --text: #111827;
    --muted: #6b7280;
    --card: #ffffff;
    --border: #e5e7eb;
    --focus: #0ea5e9;
  }
  @media (prefers-color-scheme: dark) {
    :root { --bg:#0b1220; --text:#e5e7eb; --muted:#9aa4af; --card:#0f172a; --border:#1f2937; --focus:#38bdf8; }
  }
  html, body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
  header { padding: 1rem 1.25rem; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
  h1 { margin: 0 0 .25rem 0; font-size: 1.25rem; }
  .sub { color: var(--muted); font-size: .9rem; }
  .wrap { display: grid; gap: 1rem; grid-template-columns: 1fr; padding: 1rem; max-width: 1200px; margin: 0 auto; }
  @media (min-width: 980px) { .wrap { grid-template-columns: 420px 1fr; } }
  .panel { background: var(--card); border: 1px solid var(--border); border-radius: .75rem; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
  .grid-2 { display: grid; grid-template-columns: 1fr; gap: .75rem; }
  @media (min-width: 600px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
  label { font-size: .85rem; color: var(--muted); margin-bottom: .25rem; display: block; }
  .input { display:flex; gap:.5rem; align-items:center; border:1px solid var(--border); border-radius:.5rem; padding:.5rem .75rem; background:#fff; }
  @media (prefers-color-scheme: dark) { .input { background:#111827; } }
  .input input { width:100%; border:none; outline:none; font-size:1rem; background:transparent; color:inherit; }
  .btn { border:1px solid var(--border); background:#fff; border-radius:.5rem; padding:.5rem .75rem; cursor:pointer; color:inherit; }
  .btn:hover { border-color: var(--brand); }
  .count { font-size:.9rem; color:var(--muted); margin-top:.5rem; }
  .results { list-style:none; margin:0; padding:0; }
  .result-item { padding:.75rem; border:1px solid var(--border); border-radius:.5rem; margin-bottom:.5rem; background:#fff; cursor:pointer; }
  @media (prefers-color-scheme: dark) { .result-item { background:#0b1220; } }
  .result-item:hover { border-color: var(--brand); }
  .result-main { font-weight:600; }
  .result-sub { color:var(--muted); font-size:.9rem; }
  .detail-title { font-weight:700; margin:0 0 .5rem 0; }
  dl { display:grid; grid-template-columns:minmax(160px,240px) 1fr; gap:.5rem 1rem; margin:0; }
  dt { color:var(--muted); }
  dd { margin:0; }
  .empty { color:var(--muted); font-style:italic; }
  .pill { display:inline-block; background:#eff6ff; color:#1d4ed8; border:1px solid #bfdbfe; padding:.15rem .4rem; border-radius:.375rem; font-size:.8rem; }
  .highlight { background:#fff3b0; }
  .footer { color:var(--muted); font-size:.85rem; padding: 1rem; text-align:center; }
  .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip: rect(0,0,0,0); border:0; }
  :focus-visible { outline:2px solid var(--focus); outline-offset: 2px; }
</style>
</head>
<body>
  <header>
    <h1 id="title">Assessment History</h1>
    <div class="sub">Search by Tax Serial or Address, then select a record to view full details.</div>
  </header>

  <main class="wrap" role="main">
    <section class="panel" aria-labelledby="searchHeading">
      <h2 id="searchHeading" class="sr-only">Search</h2>
      <div class="grid-2">
        <div>
          <label for="taxSearch">Tax Serial</label>
          <div class="input">
            <input id="taxSearch" type="search" placeholder="e.g., 12-345-6789" autocomplete="off" />
            <button class="btn" id="clearTax" type="button" aria-label="Clear tax search">✕</button>
          </div>
        </div>
        <div>
          <label for="addrSearch">Address</label>
          <div class="input">
            <input id="addrSearch" type="search" placeholder="e.g., 123 Main St" autocomplete="off" />
            <button class="btn" id="clearAddr" type="button" aria-label="Clear address search">✕</button>
          </div>
        </div>
      </div>
      <div class="count" id="resultCount" role="status" aria-live="polite">Loading data…</div>
      <ul class="results" id="results" aria-label="Search results"></ul>
    </section>

    <aside class="panel" aria-labelledby="detailsHeading">
      <h2 id="detailsHeading" class="detail-title">Details</h2>
      <div id="details" class="empty">Select a record to view its details.</div>
    </aside>
  </main>

  <footer class="footer">Static site · No login · No cookies</footer>

<script>
  const KEY_TAX  = 'taxSerNo';
  const KEY_ADDR = 'addressComb';
  const TITLE    = 'Assessment History';

  let DATA = [];
  let LABELS = {};
  let PRIMARY_KEYS = [];

  const $ = sel => document.querySelector(sel);

  const debounce = (fn, ms=200) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };
  const toLabel = (key) => { const s = String(key).replace(/[_\-]+/g,' ').replace(/([a-z0-9])([A-Z])/g,'$1 $2').replace(/\s+/g,' ').trim(); return s.charAt(0).toUpperCase() + s.slice(1); };
  const escapeHTML = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',''':'&#39;'}[m]));
  const highlight = (text, q) => { if (!q) return escapeHTML(text ?? ''); try { const rx = new RegExp('(' + q.replace(/[.*+?^${}()|[\]\]/g, '\$&') + ')', 'ig'); return escapeHTML(String(text ?? '')).replace(rx, '<mark class="highlight">$1</mark>'); } catch { return escapeHTML(text ?? ''); } };

  const renderResults = (rows, qTax, qAddr) => {
    const list = document.getElementById('results');
    list.innerHTML = '';
    rows.forEach(r => {
      const li = document.createElement('li');
      li.className = 'result-item';
      li.tabIndex = 0; li.setAttribute('role','button');
      li.setAttribute('aria-label','Open details for ' + (r[KEY_TAX] || r[KEY_ADDR] || 'record'));

      const main = document.createElement('div');
      main.className = 'result-main';
      const parts = [];
      if (KEY_TAX in r) parts.push('Tax: ' + highlight(r[KEY_TAX], qTax));
      if (KEY_ADDR in r) parts.push('<span class="pill">' + highlight(r[KEY_ADDR], qAddr) + '</span>');
      main.innerHTML = parts.join(' · ');

      const sub = document.createElement('div');
      sub.className = 'result-sub';
      sub.textContent = Object.keys(r).filter(k => k!==KEY_TAX && k!==KEY_ADDR).map(k => toLabel(k)+': '+(r[k] ?? '')).slice(0,2).join(' · ');

      const open = () => showDetails(r);
      li.addEventListener('click', open);
      li.addEventListener('keydown', e => { if (e.key==='Enter' || e.key===' ') open(); });

      li.appendChild(main); li.appendChild(sub);
      list.appendChild(li);
    });
    document.getElementById('resultCount').textContent = rows.length ? `${rows.length} result${rows.length===1?'':'s'}` : 'No results';
  };

  const showDetails = (row) => {
    const box = document.getElementById('details');
    const keys = Object.keys(row);
    if (!keys.length) { box.innerHTML = '<div class="empty">No data for this record.</div>'; return; }
    const dl = document.createElement('dl');
    keys.forEach(k => { const dt = document.createElement('dt'); dt.textContent = toLabel(k); const dd = document.createElement('dd'); dd.textContent = row[k] ?? ''; dl.appendChild(dt); dl.appendChild(dd); });
    box.innerHTML=''; box.appendChild(dl);
    history.replaceState(null, '', '#' + encodeURIComponent(row[KEY_TAX] ?? row[KEY_ADDR] ?? ''));
  };

  const filterData = () => {
    const qTax = document.getElementById('taxSearch').value.trim().toLowerCase();
    const qAddr = document.getElementById('addrSearch').value.trim().toLowerCase();
    let rows = DATA;
    if (qTax) rows = rows.filter(r => String(r[KEY_TAX] ?? '').toLowerCase().includes(qTax));
    if (qAddr) rows = rows.filter(r => String(r[KEY_ADDR] ?? '').toLowerCase().includes(qAddr));
    renderResults(rows.slice(0, 500), qTax, qAddr);
  };
  const filterDataDebounced = debounce(filterData, 150);

  (async function init(){
    document.title = TITLE; document.getElementById('title').textContent = TITLE;

    try {
      const res = await fetch('data.json', {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      const text = await res.text();
      if (ct.includes('application/json')) {
        DATA = JSON.parse(text);
      } else {
        try { DATA = JSON.parse(text); }
        catch(e){ throw new Error(`Expected JSON, got ${ct||'unknown'}. First 120 chars: ${text.slice(0,120)}`); }
      }
    } catch (err) {
      console.error('Failed to load data.json', err);
      document.getElementById('resultCount').textContent = 'Load failed';
      document.getElementById('details').innerHTML = '<div class="empty">Unable to load <code>data.json</code>: ' + (err && err.message ? err.message : 'unknown error') + '<br/>Tips: place <code>data.json</code> next to <code>index.html</code>, ensure exact filename & case, and load via HTTP(S), not file://.</div>';
      return;
    }

    if (DATA.length) { const sample = DATA[0]; PRIMARY_KEYS = Object.keys(sample); LABELS = Object.fromEntries(PRIMARY_KEYS.map(k=>[k,toLabel(k)])); }

    document.getElementById('taxSearch').addEventListener('input', filterDataDebounced);
    document.getElementById('addrSearch').addEventListener('input', filterDataDebounced);
    document.getElementById('clearTax').addEventListener('click', () => { document.getElementById('taxSearch').value=''; filterData(); });
    document.getElementById('clearAddr').addEventListener('click', () => { document.getElementById('addrSearch').value=''; filterData(); });

    filterData();

    const hash = decodeURIComponent(location.hash.slice(1));
    if (hash && DATA.length) {
      const cand = DATA.find(r => r[KEY_TAX] == hash || r[KEY_ADDR] == hash);
      if (cand) showDetails(cand);
    }
  })();
</script>
</body>
</html>
